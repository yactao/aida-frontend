<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIDA - Terrain de Jeux</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <a href="index.html">
                <div class="logo-icon">A</div>
                <span>AIDA</span>
            </a>
        </div>
        <nav>
            <a href="index.html" class="btn-secondary">Retour au tableau de bord</a>
        </nav>
    </header>

    <main class="main-container">
        <!-- Étape 1: Identification -->
        <div id="welcome-step" class="playground-card">
            <h1>Hello, je suis AIDA</h1>
            <p>Comment puis-je t'aider aujourd'hui ?</p>
            <form id="welcome-form">
                <div class="form-group">
                    <label for="student-name">Ton prénom</label>
                    <input type="text" id="student-name" placeholder="Ex: Paul" required>
                </div>
                <button type="submit" class="btn-main">Commencer</button>
            </form>
        </div>

        <!-- Étape 2: Sélection du sujet -->
        <div id="selection-step" class="playground-card hidden">
            <h2 id="selection-title"></h2>
            <form id="selection-form">
                <div class="form-group">
                    <label for="cycle-select">Cycle</label>
                    <select id="cycle-select">
                        <option value="">-- Choisir --</option>
                        <option value="primaire">Primaire</option>
                        <option value="college">Collège</option>
                        <option value="lycee">Lycée</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="level-select">Classe</label>
                    <select id="level-select" disabled><option>-- D'abord choisir un cycle --</option></select>
                </div>
                <div class="form-group">
                    <label for="subject-select">Matière</label>
                    <select id="subject-select" disabled><option>-- D'abord choisir une classe --</option></select>
                </div>
                <div class="form-group">
                    <label for="notion-select">Notion à réviser</label>
                    <select id="notion-select" disabled><option>-- D'abord choisir une matière --</option></select>
                </div>
                <button type="submit" class="btn-main" disabled>Discuter avec AIDA</button>
            </form>
        </div>
        
        <!-- Étape 3: Le Chat -->
        <div id="chat-step" class="chat-container hidden">
            <div class="chat-header" id="chat-header-title"></div>
            <div class="chat-messages" id="chat-messages"></div>
            <form class="chat-input" id="chat-form">
                <input type="text" id="user-input" placeholder="Pose ta question ici..." autocomplete="off">
                 <button type="button" id="hint-btn" title="Demander un indice"><i class="fa-solid fa-lightbulb"></i></button>
                <button type="submit" id="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const backendUrl = 'https://aida-backend-bqd0fnd2a3c7dadf.francecentral-01.azurewebsites.net/api';
            const welcomeStep = document.getElementById('welcome-step');
            const selectionStep = document.getElementById('selection-step');
            const chatStep = document.getElementById('chat-step');
            const welcomeForm = document.getElementById('welcome-form');
            const selectionForm = document.getElementById('selection-form');
            const chatForm = document.getElementById('chat-form');
            const studentNameInput = document.getElementById('student-name');
            const selectionTitle = document.getElementById('selection-title');
            const cycleSelect = document.getElementById('cycle-select');
            const levelSelect = document.getElementById('level-select');
            const subjectSelect = document.getElementById('subject-select');
            const notionSelect = document.getElementById('notion-select');
            const selectionButton = selectionForm.querySelector('button');
            const chatHeaderTitle = document.getElementById('chat-header-title');
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const hintBtn = document.getElementById('hint-btn');
            
            let studentName = '';
            let programmesData = null;
            let conversationHistory = [];

            welcomeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                studentName = studentNameInput.value.trim();
                if (studentName) {
                    selectionTitle.textContent = `Bonjour ${studentName}, que veux-tu réviser ?`;
                    welcomeStep.classList.add('hidden');
                    selectionStep.classList.remove('hidden');
                }
            });

            cycleSelect.addEventListener('change', async () => {
                const cycle = cycleSelect.value;
                resetSelect(levelSelect, "-- D'abord choisir un cycle --");
                resetSelect(subjectSelect, "-- D'abord choisir une classe --");
                resetSelect(notionSelect, "-- D'abord choisir une matière --");
                if (!cycle) return;
                const fileMap = { primaire: 'programmes-primaire.json', college: 'programmes-college.json', lycee: 'programmes-lycee.json' };
                try {
                    // CORRIGÉ : On va chercher le fichier sur le serveur backend
                    const response = await fetch(`${backendUrl.replace('/api', '')}/${fileMap[cycle]}`);
                    if (!response.ok) throw new Error("Le fichier programme n'a pas pu être chargé.");
                    programmesData = await response.json();
                    populateSelect(levelSelect, Object.keys(programmesData), "-- Choisir --");
                } catch (e) { alert("Impossible de charger les programmes pour ce cycle."); console.error(e); }
            });

            levelSelect.addEventListener('change', () => {
                resetSelect(subjectSelect, "-- D'abord choisir une classe --");
                resetSelect(notionSelect, "-- D'abord choisir une matière --");
                const level = levelSelect.value;
                if (level && programmesData[level]) {
                     const subjects = Object.keys(programmesData[level]).map(key => ({ key: key, name: programmesData[level][key].nom }));
                    populateSelect(subjectSelect, subjects, "-- Choisir --", true);
                }
            });
            
            subjectSelect.addEventListener('change', () => {
                resetSelect(notionSelect, "-- D'abord choisir une matière --");
                const level = levelSelect.value;
                const subject = subjectSelect.value;
                if (subject && programmesData[level]?.[subject]) {
                    const subjectData = programmesData[level][subject];
                    const allNotions = Object.keys(subjectData).filter(k => k !== 'nom').flatMap(mainKey => 
                        Object.keys(subjectData[mainKey].sous_notions).map(subKey => ({
                            key: `${mainKey},${subKey}`,
                            name: subjectData[mainKey].sous_notions[subKey].nom
                        }))
                    );
                    populateSelect(notionSelect, allNotions, "-- Choisir --", true);
                }
            });

            notionSelect.addEventListener('change', () => {
                selectionButton.disabled = !notionSelect.value;
            });
            
            selectionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const notionName = notionSelect.options[notionSelect.selectedIndex].text;
                chatHeaderTitle.textContent = `Aide sur : ${notionName}`;
                
                conversationHistory = [{
                    role: "system",
                    content: `Tu es AIDA, une enseignante IA bienveillante. Tu aides ${studentName}. La discussion porte sur: ${notionName}. Réponds de manière simple et structurée.`
                }];

                addMessage(`Bonjour ${studentName} ! Prêt(e) à explorer la notion '${notionName}' ? Pose-moi ta première question !`, "aida");

                selectionStep.classList.add('hidden');
                chatStep.classList.remove('hidden');
            });

            chatForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 sendMessage();
            });

            hintBtn.addEventListener('click', async () => {
                if (conversationHistory.length <= 1) return;
                addTypingIndicator();
                try {
                     const response = await fetch(`${backendUrl}/aida/hint`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ history: conversationHistory }) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    removeTypingIndicator();
                    addMessage(data.hint, "aida");
                } catch(error) {
                    removeTypingIndicator();
                    addMessage("Désolée, je n'ai pas trouvé d'indice.", "aida");
                }
            });
            
            async function sendMessage() {
                const userMessage = userInput.value.trim();
                if (!userMessage) return;

                addMessage(userMessage, "user");
                conversationHistory.push({ role: "user", content: userMessage });
                userInput.value = '';
                addTypingIndicator();

                try {
                    const response = await fetch(`${backendUrl}/aida/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ history: conversationHistory }) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    removeTypingIndicator();
                    addMessage(data.reply, "aida");
                    conversationHistory.push({ role: "assistant", content: data.reply });
                } catch(error) {
                    removeTypingIndicator();
                    addMessage("Désolée, une erreur est survenue. Peux-tu reformuler ?", "aida");
                }
            }
            
            function resetSelect(selectElement, defaultText) {
                selectElement.innerHTML = `<option value="">${defaultText}</option>`;
                selectElement.disabled = true;
                if(selectionButton) selectionButton.disabled = true;
            }

            function populateSelect(selectElement, options, defaultText, isObjectArray = false) {
                selectElement.innerHTML = `<option value="">${defaultText}</option>`;
                options.forEach(option => {
                    const value = isObjectArray ? option.key : option;
                    const text = isObjectArray ? option.name : option;
                    selectElement.add(new Option(text, value));
                });
                selectElement.disabled = false;
            }

            function addMessage(text, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', sender);
                const bubble = document.createElement('div');
                bubble.classList.add('message-bubble');
                bubble.textContent = text;
                messageElement.appendChild(bubble);
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function addTypingIndicator() {
                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.classList.add('message', 'aida');
                indicator.innerHTML = `<div class="message-bubble"><span></span><span></span><span></span></div>`;
                chatMessages.appendChild(indicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if(indicator) indicator.remove();
            }
        });
    </script>
</body>
</html>

